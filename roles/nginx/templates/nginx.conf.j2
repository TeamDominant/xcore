load_module /usr/lib/nginx/modules/ngx_http_geoip2_module.so;

# Global settings
user                                   nginx;
pid                                    /run/nginx.pid;
worker_processes                       auto;
worker_rlimit_nofile                   65535;
# error_log                              /var/log/nginx/error.log;
error_log                              /dev/stderr;
include                                /etc/nginx/modules-enabled/*.conf;

# Events
events {
  multi_accept                         on;
  worker_connections                   1024;
}

# HTTP settings
http {
  # GeoIP2 Country
  geoip2 /etc/nginx/geolite2/GeoLite2-Country.mmdb {
    auto_reload 12h;
    $geoip2_country_code              country iso_code;
    $geoip2_country_name              country names en;
  }

  # GeoIP2 City
  geoip2 /etc/nginx/geolite2/GeoLite2-City.mmdb {
    auto_reload 12h;
    $geoip2_city_name                  city names en;
  }

  # GeoIP2 ASN
  geoip2 /etc/nginx/geolite2/GeoLite2-ASN.mmdb {
    auto_reload 12h;
    $geoip2_asn                        autonomous_system_number;
    $geoip2_organization               autonomous_system_organization;
  }

  # Country access map
  map $geoip2_country_code $allow_country {
    default                            1;
    RU                                 1;
  }

  # Block by organization
  map $geoip2_organization $allow_organization {
    default                              1;
    "Chang Way Technologies Co. Limited" 0;
  }

  # Clean URI
  map $request_uri $cleaned_request_uri {
    default $request_uri;
    "~^(.*?)(\?x_padding=[^ ]*)$" $1;
  }

  # Исключение 127.0.0.1 из логов
  map $remote_addr $loggable {
    default 1;
    "127.0.0.1" 0;
  }

  # Logging
  log_format json_analytics escape=json '{'
    '"local": "$time_local",'
    '"addr": "$remote_addr",'
    '"request": "$request_method",'
    '"status": "$status",'
    '"uri": "$request_uri",'
    '"country": "$geoip2_country_name",'
    '"country_code": "$geoip2_country_code",'
    '"city": "$geoip2_city_name",'
    '"asn": "$geoip2_asn",'
    '"organization": "$geoip2_organization",'
    '"agent": "$http_user_agent"'
    '}';

  # Real IP
  
  # Вместо 127.0.0.1 используем общую Docker-подсеть
  # ИЛИ используйте подсеть, которую предоставляет ваш Docker по умолчанию (напр. 172.32.0.0/16)
  set_real_ip_from                     172.32.0.0/16;
  real_ip_header                       X-Forwarded-For;
  real_ip_recursive                    on;

  # Performance
  sendfile                             on;
  tcp_nopush                           on;
  tcp_nodelay                          on;

  # Security
  server_tokens                        off;
  log_not_found                        off;

  # Hash sizes
  types_hash_max_size                  2048;
  types_hash_bucket_size               64;
  variables_hash_max_size              2048;
  variables_hash_bucket_size           128;

  # Client
  client_max_body_size                 16M;

  # Keepalive
  keepalive_timeout                    75s;
  keepalive_requests                   1000;

  # Timeouts
  reset_timedout_connection            on;

  include                              /etc/nginx/mime.types;
  default_type                         application/octet-stream;

  # DNS
  resolver                             127.0.0.11 valid=60s;
  resolver_timeout                     2s;

  # Gzip Compression
  gzip on;
  gzip_vary on;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_buffers 16 8k;
  gzip_http_version 1.1;
  gzip_min_length 256;
  gzip_types
    application/atom+xml
    application/geo+json
    application/javascript
    application/x-javascript
    application/json
    application/ld+json
    application/manifest+json
    application/rdf+xml
    application/rss+xml
    application/xhtml+xml
    application/xml
    font/eot
    font/otf
    font/ttf
    image/svg+xml
    text/css
    text/javascript
    text/plain
    text/xml;

  add_header X-XSS-Protection          "0" always;
  add_header X-Content-Type-Options    "nosniff" always;
  add_header Referrer-Policy           "no-referrer-when-downgrade" always;
  add_header Permissions-Policy        "interest-cohort=()" always;
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Frame-Options           "SAMEORIGIN";
  proxy_hide_header                    X-Powered-By;

  include                              /etc/nginx/conf.d/*.conf;
}
