#!/usr/bin/env bash
set -e

LOG_FILE="/var/log/geolite2.log"
DEST_DIR="/etc/nginx/geolite2"

# Создаем директорию для логов
mkdir -p "$(dirname "$LOG_FILE")"

echo "$(date '+%Y-%m-%d %H:%M:%S'): Starting geo database update" >> $LOG_FILE
mkdir -p "$DEST_DIR" || { 
    echo "$(date '+%Y-%m-%d %H:%M:%S'): Failed to create $DEST_DIR" >> $LOG_FILE
    exit 1
}

# Получаем URL для скачивания
DOWNLOAD_URLS=$(curl -s https://api.github.com/repos/P3TERX/GeoLite.mmdb/releases/latest \
    | grep "browser_download_url" \
    | cut -d '"' -f 4 \
    | grep '\.mmdb$')

if [ -z "$DOWNLOAD_URLS" ]; then
    echo "$(date '+%Y-%m-%d %H:%M:%S'): Error: Failed to fetch download URLs." >> $LOG_FILE
    exit 1
fi

SUCCESS=false
for url in $DOWNLOAD_URLS; do
    fname=$(basename "$url")
    echo "$(date '+%Y-%m-%d %H:%M:%S'): Downloading $url to $DEST_DIR/$fname" >> $LOG_FILE
    
    # Скачиваем с помощью curl
    if curl -sL -o "$DEST_DIR/$fname.tmp" "$url"; then
        mv "$DEST_DIR/$fname.tmp" "$DEST_DIR/$fname"
        chmod 644 "$DEST_DIR/$fname"
        echo "$(date '+%Y-%m-%d %H:%M:%S'): Successfully downloaded $fname" >> $LOG_FILE
        SUCCESS=true
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S'): Failed to download $url" >> $LOG_FILE
        rm -f "$DEST_DIR/$fname.tmp" 2>/dev/null || true
    fi
done

# Перезагружаем nginx если скачивание было успешным и nginx работает
if [ "$SUCCESS" = true ]; then
    if [ -f /run/nginx.pid ] && kill -0 $(cat /run/nginx.pid 2>/dev/null) 2>/dev/null; then
        if nginx -s reload 2>> $LOG_FILE; then
            echo "$(date '+%Y-%m-%d %H:%M:%S'): Nginx reloaded successfully" >> $LOG_FILE
        else
            echo "$(date '+%Y-%m-%d %H:%M:%S'): Failed to reload nginx" >> $LOG_FILE
        fi
    else
        echo "$(date '+%Y-%m-%d %H:%M:%S'): Nginx not running, will use new DB on next start" >> $LOG_FILE
    fi
else
    echo "$(date '+%Y-%m-%d %H:%M:%S'): No files were downloaded successfully" >> $LOG_FILE
fi

echo "$(date '+%Y-%m-%d %H:%M:%S'): GeoLite2 update completed" >> $LOG_FILE
