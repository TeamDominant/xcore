---

- name: Gather installed packages
  ansible.builtin.package_facts:
    manager: auto

- name: Gather service facts
  ansible.builtin.service_facts:

- name: Detect docker package
  ansible.builtin.set_fact:
    docker_pkg_installed: >-
      {{
        ansible_facts.packages.keys()
        | select('match', '^docker')
        | list
        | length > 0
      }}

- name: Detect docker service
  ansible.builtin.set_fact:
    docker_service_exists: "{{ 'docker.service' in ansible_facts.services }}"

- name: Set docker_installed flag
  ansible.builtin.set_fact:
    docker_installed: "{{ docker_pkg_installed or docker_service_exists }}"

- name: Include tasks for Debian/Ubuntu
  ansible.builtin.include_tasks: debian.yml
  when:
    - ansible_os_family == 'Debian'
    - not docker_installed

- name: Include tasks for RedHat/CentOS/Fedora
  ansible.builtin.include_tasks: redhat.yml
  when:
    - ansible_os_family == 'RedHat'
    - not docker_installed

- name: Ensure Docker service is running and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Ensure 'docker' group exists
  ansible.builtin.group:
    name: "{{ docker_group_name }}"
    state: present

- name: Add users to the docker group
  ansible.builtin.user:
    name: "{{ item }}"
    groups: "{{ docker_group_name }}"
    append: true
  loop: "{{ docker_users_to_add }}"
